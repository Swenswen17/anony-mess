<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Anonymous Messages Online</title>
<style>
  body { font-family: Arial, sans-serif; background: #fff0f6; display: flex; flex-direction: column; align-items: center; padding: 20px; }
  h1 { color: #ff4da6; }
  #messages { width: 100%; max-width: 500px; height: 400px; border: 1px solid #ccc; padding: 10px; overflow-y: scroll; background: #fff; margin-bottom: 10px; border-radius: 8px;}
  .message, .reply { margin: 5px 0; display: flex; align-items: flex-start; gap: 5px;}
  .reply { margin-left: 20px; color: #555; font-size: 0.9em; flex-direction: column;}
  .reply-input { width: 90%; padding: 5px; margin-top: 3px; border-radius: 4px; border: 1px solid #ccc; }
  input, button, select { padding: 8px; margin: 5px 0; border-radius: 5px; border: 1px solid #ccc; width: 100%; }
  button { background: #ff4da6; color: white; border: none; cursor: pointer; }
  button:hover { background: #e03e90; }
  #authDiv { width: 100%; max-width: 400px; margin-bottom: 20px; }
  #loginBtn, #signupBtn, #logoutBtn { width: 100%; margin: 5px 0; padding: 10px; }
  #logoutBtn { background: #555; }
</style>
</head>
<body>

<h1>Anonymous Messages Online</h1>

<div id="authDiv">
  <input type="text" id="usernameInput" placeholder="Username">
  <input type="text" id="emailInput" placeholder="Email or Phone (optional)">
  <input type="password" id="passwordInput" placeholder="Password">
  <button id="signupBtn">Sign Up</button>
  <button id="loginBtn">Sign In</button>
  <button id="logoutBtn" style="display:none;">Logout</button>
</div>

<div id="messages"></div>

<input type="text" id="messageInput" placeholder="Type your message..." style="display:none;">
<select id="stickerSelect" style="display:none;">
  <option value="">Pick a sticker</option>
  <option value="‚ù§Ô∏è">‚ù§Ô∏è</option>
  <option value="üå∏">üå∏</option>
  <option value="üê±">üê±</option>
  <option value="‚ú®">‚ú®</option>
  <option value="üåà">üåà</option>
  <option value="ü•∞">ü•∞</option>
  <option value="üçì">üçì</option>
</select>
<button onclick="sendMessage()" style="display:none;" id="sendBtn">Send</button>

<audio id="music" loop></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCtVgNIqBQi_0T0yQguzYAPpXo3tTqpKGE",
  authDomain: "anonymouschatapp-61434.firebaseapp.com",
  projectId: "anonymouschatapp-61434",
  storageBucket: "anonymouschatapp-61434.firebasestorage.app",
  messagingSenderId: "513178037647",
  appId: "1:513178037647:web:36aceac41bf3c784742ffa",
  measurementId: "G-8JPJ0QPCQQ"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getFirestore(app);
const auth = getAuth();

const stickers = ['‚ù§Ô∏è','üå∏','üê±','‚ú®','üåà','ü•∞','üçì'];
const musicTracks = [
  'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
  'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3',
  'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3'
];

let currentUser = null;
let currentUsername = "";

// Elements
const usernameInput = document.getElementById('usernameInput');
const emailInput = document.getElementById('emailInput');
const passwordInput = document.getElementById('passwordInput');
const signupBtn = document.getElementById('signupBtn');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const messageInput = document.getElementById('messageInput');
const stickerSelect = document.getElementById('stickerSelect');
const sendBtn = document.getElementById('sendBtn');
const messagesDiv = document.getElementById('messages');

// Helper: create internal email if none provided
function getInternalEmail(username, email) {
  if (email) return email;
  return username + "@anonymouschatapp.com";
}

// Sign Up
signupBtn.onclick = async () => {
  const username = usernameInput.value.trim();
  const email = emailInput.value.trim();
  const password = passwordInput.value.trim();

  if (!username || !password) return alert("Username and password are required!");

  const internalEmail = getInternalEmail(username, email);

  try {
    const userCredential = await createUserWithEmailAndPassword(auth, internalEmail, password);
    currentUser = userCredential.user;
    currentUsername = username;

    // Save username in Firestore
    await setDoc(doc(db, "users", currentUser.uid), {
      username: username,
      email: email || "",
      uid: currentUser.uid
    });

    alert("Account created! Logged in as " + username);
    showChatUI();
  } catch (err) {
    alert("Sign up failed: " + err.message);
  }
};

// Sign In
loginBtn.onclick = async () => {
  const username = usernameInput.value.trim();
  const password = passwordInput.value.trim();
  if (!username || !password) return alert("Username and password are required!");

  // Lookup username in Firestore
  const q = query(collection(db, "users"), where("username", "==", username));
  const snapshot = await getDocs(q);

  if (snapshot.empty) return alert("Username not found!");

  const userData = snapshot.docs[0].data();
  const internalEmail = getInternalEmail(username, userData.email);

  try {
    const userCredential = await signInWithEmailAndPassword(auth, internalEmail, password);
    currentUser = userCredential.user;
    currentUsername = username;
    alert("Logged in as " + username);
    showChatUI();
  } catch (err) {
    alert("Sign in failed: " + err.message);
  }
};

// Logout
logoutBtn.onclick = async () => {
  await signOut(auth);
  currentUser = null;
  currentUsername = "";
  hideChatUI();
};

// Show/Hide chat UI
function showChatUI() {
  signupBtn.style.display = 'none';
  loginBtn.style.display = 'none';
  logoutBtn.style.display = 'inline-block';
  messageInput.style.display = 'block';
  stickerSelect.style.display = 'block';
  sendBtn.style.display = 'block';
}

function hideChatUI() {
  signupBtn.style.display = 'inline-block';
  loginBtn.style.display = 'inline-block';
  logoutBtn.style.display = 'none';
  messageInput.style.display = 'none';
  stickerSelect.style.display = 'none';
  sendBtn.style.display = 'none';
  messagesDiv.innerHTML = '';
}

// Load messages
const messagesQuery = query(collection(db, "messages"), orderBy("timestamp"));
onSnapshot(messagesQuery, snapshot => {
  messagesDiv.innerHTML = '';
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const msgDiv = document.createElement('div');
    msgDiv.className = 'message';
    msgDiv.textContent = `${data.sticker} ${data.username || 'Anonymous'}: ${data.text}`;

    const replyDiv = document.createElement('div');
    replyDiv.className = 'reply';
    const replyInput = document.createElement('input');
    replyInput.className = 'reply-input';
    replyInput.placeholder = 'Reply anonymously...';
    const replyBtn = document.createElement('button');
    replyBtn.textContent = 'Send';
    replyBtn.onclick = async () => {
      if (!currentUser) return alert("Login first!");
      const replyText = replyInput.value.trim();
      if (!replyText) return;
      await addDoc(collection(db, "messages", docSnap.id, "replies"), {
        text: replyText,
        sticker: stickers[Math.floor(Math.random()*stickers.length)],
        username: currentUsername || 'Anonymous',
        uid: currentUser.uid,
        timestamp: serverTimestamp()
      });
      replyInput.value = '';
    };
    replyDiv.appendChild(replyInput);
    replyDiv.appendChild(replyBtn);
    msgDiv.appendChild(replyDiv);

    // Load replies
    const repliesQuery = query(collection(db, "messages", docSnap.id, "replies"), orderBy("timestamp"));
    onSnapshot(repliesQuery, rSnap => {
      replyDiv.querySelectorAll('.reply-item')?.forEach(e => e.remove());
      rSnap.forEach(rDoc => {
        const rData = rDoc.data();
        const rDiv = document.createElement('div');
        rDiv.className = 'reply reply-item';
        rDiv.textContent = `${rData.sticker} ${rData.username || 'Anonymous'}: ${rData.text}`;
        replyDiv.appendChild(rDiv);
      });
    });

    messagesDiv.appendChild(msgDiv);
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

// Send main message
window.sendMessage = async () => {
  if (!currentUser) return alert("Please login first!");
  const msg = messageInput.value.trim();
  if (!msg) return;
  const sticker = stickerSelect.value || stickers[Math.floor(Math.random()*stickers.length)];

  await addDoc(collection(db, "messages"), {
    text: msg,
    sticker: sticker,
    username: currentUsername || 'Anonymous',
    uid: currentUser.uid,
    timestamp: serverTimestamp()
  });

  messageInput.value = '';
  stickerSelect.value = '';

  const music = document.getElementById('music');
  if (music.paused) {
    const track = musicTracks[Math.floor(Math.random()*musicTracks.length)];
    music.src = track;
    music.play();
  }
};
</script>
</body>
</html>
